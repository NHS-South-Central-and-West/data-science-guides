---
title: "Linear Regression in R: The Relationship Between Deprivation & Life Expectancy"
author: "Paul Johnson"
date: today
---

```{r}
#| label: setup

# import packages
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
})

# set plot theme
theme_set(theme_minimal())

# replace na with empty string in table outputs
options(
  knitr.kable.NA = "",
  knitr.table.format = "pipe"
)

# import data
deprivation_df <-
  readr::read_csv(here::here("data", "deprivation.csv"))

```


## Visual Exploration of Deprivation and Health Inequalities Data


```{r}
#| label: imd-score-eda

deprivation_df %>%
  psych::describe() %>%
  filter(!row_number() %in% c(1, 2)) %>%
  select(
    -vars, -n, -trimmed, -mad,
    -skew, -kurtosis, -se, -range
  ) %>%
  relocate(sd, .after = median) %>%
  knitr::kable(digits = 2)

deprivation_df %>%
  ggplot(aes(life_expectancy, imd_score)) +
  geom_point(size=3)

```

```{r}
#| label: health-index-eda

deprivation_df %>%
  ggplot(aes(life_expectancy, physiological_risk_factors)) +
  geom_point(size=3)

deprivation_df %>%
  ggplot(aes(life_expectancy, behavioural_risk_factors)) +
  geom_point(size=3)

```


```{r}
#| label: correlations

deprivation_df %>%
  select(
    area_code,
    life_expectancy,
    physiological_risk_factors,
    behavioural_risk_factors,
    imd_score
  ) %>%
  group_by(area_code) %>%
  summarise_all(.funs = "mean") %>%
  correlation::correlation() %>%
  summary() %>%
  knitr::kable(digit = 2)

```

There are strong correlations between life expectancy and the three independent variables, however, the correlation between IMD score and the two risk factor variables is also relatively strong, and in the case of behavioural risk factors, it is very strong. This could be an issue.

```{r}
#| label: correlation-eda

deprivation_df %>%
  ggplot(aes(imd_score, physiological_risk_factors)) +
  geom_point(size=3)

deprivation_df %>%
  ggplot(aes(imd_score, behavioural_risk_factors)) +
  geom_point(size=3)

deprivation_df %>%
  mutate(imd_decile = as.factor(imd_decile)) %>%
  ggplot(aes(physiological_risk_factors, imd_decile)) +
  ggridges::geom_density_ridges()

deprivation_df %>%
  mutate(imd_decile = as.factor(imd_decile)) %>%
  ggplot(aes(behavioural_risk_factors, imd_decile)) +
  ggridges::geom_density_ridges()

```

The correlations are a little more obvious when plotted and inspected visually. The behavioural risk factors have a positive linear relationship with IMD (as the value of the risk factor goes up, so does IMD score/decile).

## Linear Regression

First we will transform each of the explanatory variables to make them a little easier to interpret (particularly with regard to the intercept).

These transformations won't impact the regression results, but will just make the results easier to explain, as the intercept is no longer based on zero values of each explanatory variable (which are effectively meaningless, especially in the Health Index variables).

```{r}
#| label: transforms

imd_centre <- mean(deprivation_df$imd_score)
imd_scale <- sd(deprivation_df$imd_score)
physiological_centre <- 100
physiological_scale <- sd(deprivation_df$physiological_risk_factors)
behavioural_centre <- 100
behavioural_scale <- sd(deprivation_df$physiological_risk_factors)

deprivation_df <-
  deprivation_df %>%
  rowwise() %>%
  mutate(
    imd_transformed = (imd_score - imd_centre)/imd_scale,
    physiological_transformed = 
      (physiological_risk_factors - physiological_centre)/physiological_scale,
    behavioural_transformed = 
      (behavioural_risk_factors - behavioural_centre)/behavioural_scale
  )

deprivation_df

```

```{r}
#| label: life-expectancy-ols

life_expectancy_ols <-
  lm(life_expectancy ~ imd_transformed + physiological_transformed + behavioural_transformed,
    data = deprivation_df
  )

summary(life_expectancy_ols)

sjPlot::tab_model(
  life_expectancy_ols,
  pred.labels =
    c(
      "Intercept",
      "IMD Score",
      "Physiological Risk Factors",
      "Behavioural Risk Factors"
    ),
  dv.labels = c("Life Expectancy")
)

```

The results suggest that each of the explanatory variables has a small but significant effect on life expectancy. As deprivation increases (IMD score increases), life expectancy decreases, while as the index score representing physiological and behavioural risk factors (meaning a better performance in that Health Index subdomain) increases, life expectancy increases.